<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Langdalsvej Regnskab v10</title>
    <style>
        :root { --primary: #5856D6; --success: #34C759; --danger: #FF3B30; --bg: #F2F2F7; --card: #FFFFFF; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 0; color: #1C1C1E; }
        .view { display: none; padding: 20px; padding-bottom: 100px; }
        .active { display: block; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .stat-label { font-size: 12px; color: #8E8E93; text-transform: uppercase; }
        .stat-value { font-size: 22px; font-weight: bold; margin-top: 5px; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .menu-btn { background: var(--card); border: none; padding: 20px; border-radius: 20px; font-size: 14px; font-weight: 600; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #DDD; font-size: 16px; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 15px; margin-bottom: 20px; overflow: hidden; table-layout: fixed; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #EEE; }
        .header-row { background: #f8f8f8; font-weight: bold; color: var(--primary); }
        .total-row { font-weight: bold; background: #fafafa; border-top: 2px solid #EEE; }
        .amount { text-align: right; width: 120px; font-variant-numeric: tabular-nums; }
        button.primary { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px; font-size: 16px; font-weight: bold; margin-top: 10px; }
        .back-btn { width: 100%; background: none; border: 1px solid #DDD; color: #8E8E93; padding: 12px; border-radius: 12px; font-size: 14px; margin-top: 10px; }
        .journal-item { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 5px solid var(--primary); }
        .direction-toggle { display: flex; align-items: center; justify-content: center; margin: 10px 0; font-size: 24px; cursor: pointer; background: #EEE; border-radius: 10px; padding: 5px; }
        .logic-hint { font-size: 12px; color: #5856D6; text-align: center; margin: 10px 0; font-weight: 500; min-height: 1.2em; }
    </style>
</head>
<body>

<div id="view-home" class="view active">
    <h1>Langdalsvej</h1>
    <div class="stat-card">
        <div class="stat-label">√Örets Resultat</div>
        <div id="dash-ytd" class="stat-value">0,00 kr.</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Bank Beholdning</div>
        <div id="dash-bank" class="stat-value" style="color:var(--success)">0,00 kr.</div>
    </div>
    <div class="menu-grid">
        <button class="menu-btn" onclick="showView('entry')"><span>‚ûï</span>Kassekladde</button>
        <button class="menu-btn" onclick="showView('journal')"><span>üìã</span>Journal</button>
        <button class="menu-btn" onclick="showView('report-res')"><span>üìà</span>Resultat</button>
        <button class="menu-btn" onclick="showView('report-bal')"><span>‚öñÔ∏è</span>Balance</button>
        <button class="menu-btn" onclick="showView('accounts')" style="grid-column: span 2;"><span>‚öôÔ∏è</span>Konti</button>
    </div>
</div>

<div id="view-entry" class="view">
    <h2 id="entry-title">Ny Postering</h2>
    <input type="hidden" id="edit-id">
    <input type="date" id="entry-date">
    
    <label>Fra Konto (Mindskes normalt)</label>
    <select id="entry-account" onchange="updateLogicHint()"></select>
    
    <div class="direction-toggle" onclick="toggleDirection()">
        <span id="dir-arrow">‚ûî</span>
    </div>

    <label>Til Konto (√òges normalt)</label>
    <select id="entry-offset" onchange="updateLogicHint()"></select>
    
    <input type="text" id="entry-desc" placeholder="Beskrivelse">
    <input type="number" step="0.01" id="entry-amount" placeholder="Bel√∏b" style="text-align: right; font-size: 28px; font-weight: bold;" oninput="updateLogicHint()">
    
    <div id="logic-hint" class="logic-hint"></div>
    
    <button class="primary" onclick="saveEntry()">BOGF√òR</button>
    <button class="back-btn" onclick="showView('home')">Tilbage</button>
</div>

<div id="view-journal" class="view">
    <h2>Journal</h2>
    <div id="journal-list"></div>
    <button class="back-btn" onclick="showView('home')">Tilbage</button>
</div>
<div id="view-report-res" class="view"><h2>Resultat</h2><div id="res-content"></div><button class="back-btn" onclick="showView('home')">Tilbage</button></div>
<div id="view-report-bal" class="view"><h2>Balance</h2><div id="bal-content"></div><button class="back-btn" onclick="showView('home')">Tilbage</button></div>
<div id="view-accounts" class="view"><h2>Konti</h2><div id="acc-list"></div><button class="back-btn" onclick="showView('home')">Tilbage</button></div>

<script>
    const FMT = (n) => n.toLocaleString('da-DK', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    let currentDir = 1; 

    let accounts = JSON.parse(localStorage.getItem('h_acc_v8')) || [
        {id: 1, name: "Lejeindt√¶gt", type: "Indt√¶gt"},
        {id: 2, name: "Vedligehold", type: "Udgift"},
        {id: 3, name: "Bank", type: "Aktiv"},
        {id: 4, name: "L√•n", type: "Passiv"}
    ];
    let journal = JSON.parse(localStorage.getItem('h_jou_v8')) || [];

    function showView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-'+id).classList.add('active');
        if(id==='home') updateDash();
        if(id==='entry') renderEntry();
        if(id==='journal') renderJournal();
        if(id==='report-res') renderResult();
        if(id==='report-bal') renderBalance();
        if(id==='accounts') renderAccounts();
    }

    function toggleDirection() {
        currentDir *= -1;
        document.getElementById('dir-arrow').innerText = currentDir === 1 ? "‚ûî" : "‚¨Ö";
        updateLogicHint();
    }

    function renderEntry() {
        const sorted = accounts.sort((a,b) => a.id - b.id);
        document.getElementById('entry-account').innerHTML = sorted.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
        document.getElementById('entry-offset').innerHTML = sorted.filter(a => a.type === 'Aktiv' || a.type === 'Passiv').map(a => `<option value="${a.id}">${a.name}</option>`).join('');
        document.getElementById('entry-date').valueAsDate = new Date();
        updateLogicHint();
    }

    function updateLogicHint() {
        const amt = parseFloat(document.getElementById('entry-amount').value) || 0;
        const aId = document.getElementById('entry-account').value;
        const oId = document.getElementById('entry-offset').value;
        const acc = accounts.find(x => x.id == aId);
        const off = accounts.find(x => x.id == oId);
        
        if (!acc || !off || amt === 0) return;

        let txt = "";
        if (currentDir === 1) {
            txt = `Fjerner ${FMT(amt)} fra ${acc.name} og l√¶gger dem p√• ${off.name}`;
        } else {
            txt = `Fjerner ${FMT(amt)} fra ${off.name} og l√¶gger dem p√• ${acc.name}`;
        }
        document.getElementById('logic-hint').innerText = txt;
    }

    function saveEntry() {
        const amt = parseFloat(document.getElementById('entry-amount').value);
        const aId = parseInt(document.getElementById('entry-account').value);
        const oId = parseInt(document.getElementById('entry-offset').value);
        if(!amt) return;

        const acc = accounts.find(x => x.id === aId);
        const off = accounts.find(x => x.id === oId);
        const gid = Date.now().toString();
        const date = document.getElementById('entry-date').value;
        const desc = document.getElementById('entry-desc').value;

        // DENNE LOGIK SIKRER RIGTIGT FORTEGN P√Ö PASSIVER
        // Ved ‚ûî: Konto A falder (-), Konto B stiger (+)
        // Da passiver er positive som g√¶ld, vil +407 p√• en passiv-konto √∏ge saldoen.
        
        let valA = amt * -1 * currentDir;
        let valB = amt * 1 * currentDir;

        // S√¶rlig regel for udgifter: De skal altid ende som negative i systemet for at tr√¶kke fra indt√¶gt
        if (acc.type === "Udgift") valA = amt * -1; 

        journal.push({ groupId: gid, date, accId: aId, amount: valA, desc, isPrimary: true, offId: oId });
        journal.push({ groupId: gid, date, accId: oId, amount: valB, desc: "Modpost: " + desc, isPrimary: false });

        localStorage.setItem('h_jou_v8', JSON.stringify(journal));
        showView('home');
    }

    // Standard funktioner til visning
    function renderJournal() {
        document.getElementById('journal-list').innerHTML = journal.filter(j => j.isPrimary).reverse().map(j => `
            <div class="journal-item">
                <div style="font-size:11px">${j.date}</div>
                <strong>${j.desc}</strong><br>
                ${accounts.find(a=>a.id==j.accId).name}: ${FMT(j.amount)} kr.
                <button onclick="deletePost('${j.groupId}')" style="float:right; color:red">Slet</button>
            </div>`).join('');
    }

    function deletePost(gid) { journal = journal.filter(j => j.groupId !== gid); localStorage.setItem('h_jou_v8', JSON.stringify(journal)); renderJournal(); }

    function renderBalance() {
        let html = "<table>";
        accounts.filter(a => a.type === 'Aktiv' || a.type === 'Passiv').forEach(a => {
            const sum = journal.filter(j => j.accId === a.id).reduce((s,j) => s + j.amount, 0);
            html += `<tr><td>${a.name} (${a.type})</td><td class="amount">${FMT(sum)}</td></tr>`;
        });
        html += "</table>";
        document.getElementById('bal-content').innerHTML = html;
    }

    function renderResult() {
        let res = 0;
        let html = "<table>";
        accounts.filter(a => a.type === 'Indt√¶gt' || a.type === 'Udgift').forEach(a => {
            const sum = journal.filter(j => j.accId === a.id).reduce((s,j) => s + j.amount, 0);
            res += sum;
            html += `<tr><td>${a.name}</td><td class="amount">${FMT(sum)}</td></tr>`;
        });
        html += `<tr class="total-row"><td>RESULTAT</td><td class="amount">${FMT(res)}</td></tr></table>`;
        document.getElementById('res-content').innerHTML = html;
    }

    function updateDash() {
        const bank = journal.filter(j => j.accId === 3).reduce((s,j) => s + j.amount, 0);
        document.getElementById('dash-bank').innerText = FMT(bank) + " kr.";
        const res = journal.filter(j => {
            const acc = accounts.find(a => a.id === j.accId);
            return acc.type === 'Indt√¶gt' || acc.type === 'Udgift';
        }).reduce((s,j) => s + j.amount, 0);
        document.getElementById('dash-ytd').innerText = FMT(res) + " kr.";
    }

    function renderAccounts() {
        document.getElementById('acc-list').innerHTML = accounts.map(a => `<div>${a.id}: ${a.name} (${a.type})</div>`).join('');
    }

    showView('home');
</script>
</body>
</html>
