<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Langdalsvej Regnskab</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <style>
        :root { --primary: #5856D6; --success: #34C759; --danger: #FF3B30; --bg: #F2F2F7; --card: #FFFFFF; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 0; color: #1C1C1E; }
        .view { display: none; padding: 20px; padding-bottom: 100px; }
        .active { display: block; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .stat-label { font-size: 12px; color: #8E8E93; text-transform: uppercase; }
        .stat-value { font-size: 22px; font-weight: bold; margin-top: 5px; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .menu-btn { background: var(--card); border: none; padding: 20px; border-radius: 20px; font-size: 14px; font-weight: 600; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #DDD; font-size: 16px; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 15px; margin-bottom: 20px; overflow: hidden; table-layout: fixed; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #EEE; }
        .header-row { background: #f8f8f8; font-weight: bold; color: var(--primary); }
        .total-row { font-weight: bold; background: #fafafa; border-top: 2px solid #EEE; }
        .amount { text-align: right; width: 120px; font-variant-numeric: tabular-nums; }
        button.primary { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 12px; font-size: 16px; font-weight: bold; margin-top: 10px; }
        .back-btn { width: 100%; background: none; border: 1px solid #DDD; color: #8E8E93; padding: 12px; border-radius: 12px; font-size: 14px; margin-top: 10px; }
        .journal-item { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 5px solid var(--primary); }
        .action-btns { display: flex; gap: 10px; margin-top: 10px; }
        .action-btns button { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #EEE; font-size: 12px; }
        .acc-edit-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; background: white; padding: 10px; border-radius: 10px; }
        .direction-toggle { display: flex; align-items: center; justify-content: center; gap: 10px; margin: 10px 0; font-size: 20px; font-weight: bold; color: var(--primary); cursor: pointer; }
        .logic-hint { font-size: 11px; color: #8E8E93; text-align: center; margin-bottom: 10px; line-height: 1.4; }
    </style>
</head>
<body>

<div id="view-home" class="view active">
    <h1>Langdalsvej</h1>
    <div class="stat-card">
        <div class="stat-label">√Örets Resultat (Netto)</div>
        <div id="dash-ytd" class="stat-value">0,00 kr.</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Bank Beholdning</div>
        <div id="dash-bank" class="stat-value" style="color:var(--success)">0,00 kr.</div>
    </div>
    <div class="menu-grid">
        <button class="menu-btn" onclick="showView('entry')"><span>‚ûï</span>Kassekladde</button>
        <button class="menu-btn" onclick="showView('journal')"><span>üìã</span>Journal</button>
        <button class="menu-btn" onclick="showView('report-res')"><span>üìà</span>Resultat</button>
        <button class="menu-btn" onclick="showView('report-bal')"><span>‚öñÔ∏è</span>Balance</button>
        <button class="menu-btn" onclick="showView('accounts')" style="grid-column: span 2;"><span>‚öôÔ∏è</span>Indstillinger & Konti</button>
    </div>
</div>

<div id="view-entry" class="view">
    <h2 id="entry-title">Ny Postering</h2>
    <input type="hidden" id="edit-id">
    <input type="date" id="entry-date">
    <label>Fra / Konto</label>
    <select id="entry-account" onchange="updateLogicHint()"></select>
    <br>
    <div class="direction-toggle" onclick="toggleDirection()">
        <span id="dir-arrow">‚ûî</span>
    </div>

    <label>Til / Modkonto</label>
    <select id="entry-offset" onchange="updateLogicHint()"></select>
    <br>
    <input type="text" id="entry-desc" placeholder="Beskrivelse">
    <input type="number" step="0.01" id="entry-amount" placeholder="Bel√∏b" style="text-align: right; font-size: 28px; font-weight: bold;" oninput="updateLogicHint()">
    <br>
    <div id="logic-hint" class="logic-hint">V√¶lg konti og bel√∏b for at se konsekvens.</div>
    <br>
    <button class="primary" onclick="saveEntry()">BOGF√òR</button>
    <button class="back-btn" onclick="showView('home')">Tilbage</button>
</div>

<div id="view-journal" class="view">
    <h2>Journal</h2>
    <div class="filter-grid" style="display: flex; gap: 10px; margin-bottom: 15px;">
        <select id="filter-acc" onchange="renderJournal()"><option value="all">Alle Konti</option></select>
        <select id="filter-year" onchange="renderJournal()"><option value="all">Alle √Ör</option></select>
    </div>
    <div id="journal-list"></div>
    <button class="back-btn" onclick="showView('home')">Tilbage</button>
</div>

<div id="view-report-res" class="view">
    <h2>Resultatopg√∏relse</h2>
    <div id="res-content"></div>
    <button class="back-btn" onclick="showView('home')">Tilbage</button>
</div>

<div id="view-report-bal" class="view">
    <h2>Balance</h2>
    <div id="bal-content"></div>
    <button class="back-btn" onclick="showView('home')">Tilbage</button>
</div>

<div id="view-accounts" class="view">
    <h2>Kontostyring</h2>
    <div class="stat-card">
        <input type="text" id="new-acc-name" placeholder="Navn p√• konto">
        <select id="new-acc-type">
            <option value="Indt√¶gt">Indt√¶gt</option>
            <option value="Udgift">Udgift</option>
            <option value="Aktiv">Aktiv</option>
            <option value="Passiv">Passiv</option>
        </select>
        <button class="primary" onclick="addAccount()">Opret konto</button>
    </div>
    <div id="acc-list"></div>
    <button class="primary" style="background:var(--success)" onclick="exportCSV()">EKSPORTER CSV</button>
    <div style="margin-top:20px; text-align:center;">
        <input type="file" id="csv-file" accept=".csv" onchange="importCSV(event)" style="display:none">
        <button class="back-btn" onclick="document.getElementById('csv-file').click()">IMPORTER CSV</button>
    </div>
    <button class="primary" style="background:var(--danger)" onclick="clearAll()">SLET ALT DATA</button>
    <button class="back-btn" onclick="showView('home')">Tilbage</button>
</div>

<script>
    const FMT = (n) => n.toLocaleString('da-DK', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const TYPE_ORDER = { "Indt√¶gt": 1, "Udgift": 2, "Aktiv": 3, "Passiv": 4 };
    let currentDir = 1; 

    let accounts = JSON.parse(localStorage.getItem('h_acc_v8')) || [
        {id: 1, name: "Lejeindt√¶gt", type: "Indt√¶gt"},
        {id: 2, name: "Vedligehold", type: "Udgift"},
        {id: 3, name: "Bank", type: "Aktiv"},
        {id: 4, name: "L√•n", type: "Passiv"}
    ];
    let journal = JSON.parse(localStorage.getItem('h_jou_v8')) || [];

    function toggleDirection() {
        currentDir *= -1;
        document.getElementById('dir-arrow').innerText = currentDir === 1 ? "‚ûî" : "‚¨Ö";
        updateLogicHint();
    }

    function getSortedAccounts() {
        return [...accounts].sort((a, b) => {
            if (TYPE_ORDER[a.type] !== TYPE_ORDER[b.type]) return TYPE_ORDER[a.type] - TYPE_ORDER[b.type];
            return a.id - b.id;
        });
    }

    function showView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-'+id).classList.add('active');
        if(id==='home') updateDash();
        if(id==='entry') renderEntry(document.getElementById('edit-id').value || null);
        if(id==='journal') { populateFilters(); renderJournal(); }
        if(id==='report-res') renderResult();
        if(id==='report-bal') renderBalance();
        if(id==='accounts') renderAccounts();
    }

    function renderEntry(editId = null) {
        currentDir = 1;
        document.getElementById('dir-arrow').innerText = "‚ûî";
        const sorted = getSortedAccounts();
        document.getElementById('entry-account').innerHTML = sorted.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
        document.getElementById('entry-offset').innerHTML = sorted.filter(a => a.type === 'Aktiv' || a.type === 'Passiv').map(a => `<option value="${a.id}">${a.name}</option>`).join('');
        
        if(editId) {
            const j = journal.find(x => x.groupId === editId && x.isPrimary);
            if(j) {
                document.getElementById('entry-date').value = j.date;
                document.getElementById('entry-account').value = j.accId;
                document.getElementById('entry-offset').value = j.offId;
                document.getElementById('entry-desc').value = j.desc;
                document.getElementById('entry-amount').value = Math.abs(j.amount);
            }
        } else {
            document.getElementById('edit-id').value = "";
            document.getElementById('entry-date').valueAsDate = new Date();
            document.getElementById('entry-offset').value = 3;
            document.getElementById('entry-desc').value = "";
            document.getElementById('entry-amount').value = "";
        }
        updateLogicHint();
    }

    function updateLogicHint() {
        const amt = parseFloat(document.getElementById('entry-amount').value) || 0;
        const acc = accounts.find(a => a.id == document.getElementById('entry-account').value);
        const off = accounts.find(a => a.id == document.getElementById('entry-offset').value);
        if (!acc || !off || amt === 0) return;
        let hint = currentDir === 1 ? `Flytter fra ${acc.name} til ${off.name}` : `Flytter fra ${off.name} til ${acc.name}`;
        document.getElementById('logic-hint').innerText = hint;
    }

    function saveEntry() {
        const amt = parseFloat(document.getElementById('entry-amount').value);
        const accId = parseInt(document.getElementById('entry-account').value);
        const offId = parseInt(document.getElementById('entry-offset').value);
        const editId = document.getElementById('edit-id').value;
        if(!amt || accId === offId) return alert("Fejl i indtastning");

        if(editId) journal = journal.filter(j => j.groupId !== editId);
        const groupId = editId || Date.now().toString();
        const acc = accounts.find(a => a.id === accId);
        const off = accounts.find(a => a.id === offId);
        
        let valA, valB;

        // DEN NYE LOGIK DER FIXER INDT√ÜGTER OG PASSIVER
        if (acc.type === 'Indt√¶gt') {
            // Indt√¶gt: Begge stiger (+)
            valA = amt * currentDir;
            valB = amt * currentDir;
        } else if (acc.type === 'Passiv' && off.type === 'Passiv') {
            // Passiv til Passiv: Fra falder (-), Til stiger (+)
            valA = amt * -1 * currentDir;
            valB = amt * currentDir;
        } else if (acc.type === 'Passiv' && off.type === 'Aktiv') {
            // Modtagelse af depositum (Passiv stiger, Aktiv stiger)
            valA = amt * currentDir;
            valB = amt * currentDir;
        } else {
            // Standard (Udgift/Aktiv-Aktiv): Fra falder (-), Til stiger (+)
            valA = amt * -1 * currentDir;
            valB = amt * currentDir;
        }

        journal.push({ groupId, date: document.getElementById('entry-date').value, accId, offId, amount: valA, desc: document.getElementById('entry-desc').value, isPrimary: true });
        journal.push({ groupId, date: document.getElementById('entry-date').value, accId: offId, amount: valB, desc: "Modpost: " + document.getElementById('entry-desc').value, isPrimary: false });

        localStorage.setItem('h_jou_v8', JSON.stringify(journal));
        document.getElementById('edit-id').value = "";
        showView('home');
    }

    function reversePost(gid) {
        const original = journal.filter(j => j.groupId === gid);
        const newGid = "rev_" + Date.now();
        original.forEach(o => {
            journal.push({...o, groupId: newGid, amount: o.amount * -1, desc: "TILBAGEF√òRSEL: " + o.desc, date: new Date().toISOString().split('T')[0]});
        });
        localStorage.setItem('h_jou_v8', JSON.stringify(journal));
        renderJournal();
    }

    function populateFilters() {
        const accF = document.getElementById('filter-acc');
        const yearF = document.getElementById('filter-year');
        accF.innerHTML = '<option value="all">Alle Konti</option>' + accounts.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
        const years = [...new Set(journal.map(j => j.date.substring(0,4)))].sort((a,b) => b-a);
        yearF.innerHTML = '<option value="all">Alle √Ör</option>' + years.map(y => `<option value="${y}">${y}</option>`).join('');
    }

    function renderJournal() {
        const accVal = document.getElementById('filter-acc').value;
        const yearVal = document.getElementById('filter-year').value;
        const filtered = journal.filter(j => j.isPrimary).filter(j => {
            const matchAcc = (accVal === 'all' || j.accId == accVal || j.offId == accVal);
            const matchYear = (yearVal === 'all' || j.date.startsWith(yearVal));
            return matchAcc && matchYear;
        });
        document.getElementById('journal-list').innerHTML = filtered.sort((a,b) => new Date(b.date) - new Date(a.date)).map(j => `
            <div class="journal-item">
                <div style="font-size:11px; color:gray">${j.date}</div>
                <strong>${j.desc}</strong>
                <div style="display:flex; justify-content:space-between">
                    <span>${accounts.find(a=>a.id==j.accId)?.name || 'Slettet'}</span>
                    <span class="amount">${FMT(j.amount)} kr.</span>
                </div>
                <div class="action-btns">
                    <button onclick="document.getElementById('edit-id').value='${j.groupId}'; showView('entry');">Ret</button>
                    <button onclick="reversePost('${j.groupId}')">Tilbagef√∏r</button>
                    <button style="color:var(--danger)" onclick="deletePost('${j.groupId}')">Slet</button>
                </div>
            </div>`).join('');
    }

    function deletePost(gid) {
        if(confirm("Slet postering permanent?")) {
            journal = journal.filter(g => g.groupId !== gid);
            localStorage.setItem('h_jou_v8', JSON.stringify(journal));
            renderJournal();
        }
    }

    function renderResult() {
        let iT = 0, uT = 0;
        let html = `<table><tr class="header-row"><td>INDT√ÜGTER</td><td class="amount">Kr.</td></tr>`;
        accounts.filter(a => a.type==='Indt√¶gt').forEach(a => {
            const b = journal.filter(j => j.accId === a.id).reduce((s,j)=>s+j.amount,0);
            iT += b; html += `<tr><td>${a.name}</td><td class="amount">${FMT(b)}</td></tr>`;
        });
        html += `<tr class="total-row"><td>Total Indt√¶gter</td><td class="amount">${FMT(iT)}</td></tr></table>`;
        html += `<table><tr class="header-row"><td>UDGIFTER</td><td class="amount">Kr.</td></tr>`;
        accounts.filter(a => a.type==='Udgift').forEach(a => {
            const b = journal.filter(j => j.accId === a.id).reduce((s,j)=>s+j.amount,0);
            uT += b; html += `<tr><td>${a.name}</td><td class="amount">${FMT(Math.abs(b))}</td></tr>`;
        });
        html += `<tr class="total-row"><td>Total Udgifter</td><td class="amount">${FMT(Math.abs(uT))}</td></tr></table>`;
        html += `<div class="stat-card" style="text-align:center"><div class="stat-label">√ÖRETS RESULTAT</div><div class="stat-value">${FMT(iT + uT)} kr.</div></div>`;
        document.getElementById('res-content').innerHTML = html;
    }

    function renderBalance() {
        let aT = 0, pT = 0;
        let html = `<table><tr class="header-row"><td>AKTIVER</td><td class="amount">Kr.</td></tr>`;
        accounts.filter(a => a.type==='Aktiv').forEach(a => {
            const b = journal.filter(j => j.accId === a.id).reduce((s,j)=>s+j.amount,0);
            aT += b; html += `<tr><td>${a.name}</td><td class="amount">${FMT(b)}</td></tr>`;
        });
        html += `<tr class="total-row"><td>TOTAL AKTIVER</td><td class="amount">${FMT(aT)}</td></tr></table>`;
        html += `<table><tr class="header-row"><td>PASSIVER</td><td class="amount">Kr.</td></tr>`;
        accounts.filter(a => a.type==='Passiv').forEach(a => {
            const b = journal.filter(j => j.accId === a.id).reduce((s,j)=>s+j.amount,0);
            pT += b; html += `<tr><td>${a.name}</td><td class="amount">${FMT(b)}</td></tr>`;
        });
        const egenkapital = aT - pT;
        html += `<tr><td>Egenkapital (Beregnet)</td><td class="amount">${FMT(egenkapital)}</td></tr>`;
        html += `<tr class="total-row"><td>TOTAL PASSIVER</td><td class="amount">${FMT(pT + egenkapital)}</td></tr></table>`;
        document.getElementById('bal-content').innerHTML = html;
    }

    function updateDash() {
        const bank = journal.filter(j => j.accId === 3).reduce((s,j) => s + j.amount, 0);
        document.getElementById('dash-bank').innerText = FMT(bank) + " kr.";
        const i = journal.filter(j => accounts.find(a=>a.id==j.accId).type==='Indt√¶gt').reduce((s,j)=>s+j.amount,0);
        const u = journal.filter(j => accounts.find(a=>a.id==j.accId).type==='Udgift').reduce((s,j)=>s+j.amount,0);
        document.getElementById('dash-ytd').innerText = FMT(i + u) + " kr.";
    }

    function renderAccounts() {
        document.getElementById('acc-list').innerHTML = accounts.map(a => `
            <div class="acc-edit-row">
                <div style="font-weight:bold; width:30px;">${a.id}</div>
                <input type="text" value="${a.name}" onchange="updateAccName(${a.id}, this.value)" style="margin:0; flex:1">
                <div style="font-size:10px; color:gray; width:50px;">${a.type}</div>
                ${journal.some(j=>j.accId===a.id) ? '' : `<button onclick="delAcc(${a.id})" style="color:red; background:none; border:none;">‚úï</button>`}
            </div>`).join('');
    }

    function updateAccName(id, newName) {
        const acc = accounts.find(a => a.id === id);
        if(acc) { acc.name = newName; localStorage.setItem('h_acc_v8', JSON.stringify(accounts)); }
    }

    function delAcc(id) { accounts = accounts.filter(x=>x.id!==id); localStorage.setItem('h_acc_v8', JSON.stringify(accounts)); renderAccounts(); }
    
    function addAccount() {
        const n = document.getElementById('new-acc-name').value;
        const t = document.getElementById('new-acc-type').value;
        if(n) {
            const lastId = accounts.length > 0 ? Math.max(...accounts.map(a => a.id)) : 0;
            accounts.push({id: lastId + 1, name: n, type: t});
            localStorage.setItem('h_acc_v8', JSON.stringify(accounts));
            renderAccounts();
            document.getElementById('new-acc-name').value = "";
        }
    }

    function exportCSV() {
        let csv = "Dato;KontoID;ModID;Beskrivelse;Bel√∏b\n";
        journal.filter(j => j.isPrimary).forEach(j => csv += `${j.date};${j.accId};${j.offId};${j.desc};${j.amount}\n`);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.setAttribute("download", "langdalsvej_data.csv");
        link.click();
    }

    function importCSV(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const lines = e.target.result.split('\n');
            const newEntries = [];
            for(let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(';');
                if(cols.length < 5) continue;
                const date = cols[0], accId = parseInt(cols[1]), offId = parseInt(cols[2]), desc = cols[3], amt = parseFloat(cols[4]);
                if(!date || isNaN(accId)) continue;
                const gid = "imp_" + Date.now() + "_" + i;
                newEntries.push({ groupId: gid, date, accId, offId, amount: amt, desc, isPrimary: true });
                newEntries.push({ groupId: gid, date, accId: offId, amount: amt * -1, desc: "Modpost: " + desc, isPrimary: false });
            }
            if(confirm("Importer " + (newEntries.length/2) + " posteringer?")) {
                journal = journal.concat(newEntries);
                localStorage.setItem('h_jou_v8', JSON.stringify(journal));
                showView('home');
            }
        };
        reader.readAsText(file);
    }

    function clearAll() { if(confirm("Slet alt? Dette kan ikke fortrydes!")) { localStorage.clear(); location.reload(); } }
    showView('home');
</script>
</body>
</html>
